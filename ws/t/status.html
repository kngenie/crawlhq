$def with(jobs)
<html>
<head>
<title>Crawl Headquarters</title>
<link rel="stylesheet" type="text/css" href="hq.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<style type="text/css">
table { border-collapse:collapse; }
.job { margin-bottom: 6px; }
td.n { text-align: right; }
.loading { color: #666; }
.wait {
  padding-right: 18px;
  background: transparent url(img/wait.gif) 100% 50% no-repeat;
}
</style>
</head>
<body>
<h1>Crawl Headquarters</h1>
<div>
<h2>Jobs (${len(jobs)})</h2>
$for i, j in enumerate(jobs):
  <div class="job" jobname="${j.name}">
    <div class="jtitle">${i+1}: ${j.name}</div>
    <div class="jobdetail">
      <span>Seen: <span class="seencount">-</span></span>
      <button class="update-seencount">Update</button>
    </div>
    <div>
      <button>Reset</button>
      <button class="flush">Flush</button>
      <button>Seed</button>
    </div>
    <h3><a href="#" class="showstatus">Status</a></h3>
    <div class="jobstatus">
    </div>
    <h3>Query</h3>
    <form id="seencheck_${j.name}" class="seencheck" job="${j.name}">
    Type URL: <input type="text" size="100" name="url" id="url">
    <input type="submit" value="Check">
    </form>
    <div id="seencheckresult_${j.name}"></div>
  </div>
$# % endfor
<div><button>Add Job</button></div>
</div>
</body>
<script type="text/javascript">
function schedule(ev) {
  var url = this.u;
  if (url) {
    var b = ev.target;
    var job = getjobname(b);
    if (!job) { alert('failed to identify job'); return; }
    b.disabled = true;
    jQuery.ajax('jobs/'+job+'/discovered', {
      type:'POST',
      data:{u:url, force:1},
      dataType:'json',
      success:function(data, status, xhr) {
        jQuery('#seencheckresult_'+job).html(data.scheduled ? 'scheduled'
          : 'already seen');
      },
    });
  }
}
function seencheck(ev) {
  var job = getjobname(this);
  //console.log(this);
  var url = this.url.value;
  if (url == "") return false;
  if (!url.match('http://'))
    url = 'http://' + url;
  //console.log(url);
  jQuery('#seencheckresult_'+job).empty();
  jQuery.ajax('jobs/'+encodeURIComponent(job)+'/seen', {
    data:{u:url},
    dataType:'json',
    success:function(data, status, xhr) {
      //console.log(data);
      var tbl = [];
      var seen = 0;
      var u = data.u;
      if (u) {
        if (u.id) { tbl.push(['ID', u.id]); }
        if (u.f) {
          tbl.push(['Crawled on', new Date(u.f*1000).toString()]);
          seen = 1;
        }
        if (u.e) {
          tbl.push(['Expires on', new Date(u.e*1000).toString()]);
          seen = 1;
        }
      }
      var e = jQuery('#seencheckresult_'+job).empty();
      e.append(seen ? 'seen' : 'not seen');
      jQuery('<button>Schedule</button>')
        .click(jQuery.proxy(schedule, {u:url})).appendTo(e);
      if (tbl.length > 0) {
        var t = jQuery('<table border="1">').get(0);
        jQuery.each(tbl, function(i, r){
            jQuery('<tr>').append(
              jQuery('<td>').append(r[0]), jQuery('<td>').append(r[1]))
	      .appendTo(t);
	  });
	e.append(t);
      }
    }
  });
  return false;
}
var last_status_update = 0;
var last_inq_in = 0;
var last_inq_out = 0;
function renderstatus(data, status, xhr) {
  //console.log(data);
  var d = jQuery('.jobstatus', '.job[jobname="'+data.job+'"]');
  d.empty();
  if ('workqueuesize' in data) {
    jQuery('<div>').text('WorkQueueSize: ' + data.workqueuesize).appendTo(d);
  }
  var inq = data.inq;
  if (inq) {
    var inqdiv = jQuery('<div>');
    var in_text = 'in=' + with_comma(inq.addedcount);
    var out_text = 'out=' + with_comma(inq.processedcount);
    var nq_text = 'nqfiles=' + with_comma(inq.queuefilecount);
    var now = (new Date()).getTime();
    var elapsed_ms = now - last_status_update;
    if (elapsed_ms < 3600000) {
      var in_speed = (inq.addedcount - last_inq_in) / (elapsed_ms / 1000);
      if (in_speed >= 0 && in_speed < 1000000) {
        in_text += ' (' + (Math.floor(in_speed * 10)/10) + ' URI/s)';
      }
      var out_speed = (inq.processedcount - last_inq_out) / (elapsed_ms / 1000);
      if (out_speed >= 0 && out_speed < 100000) {
        out_text += ' (' + (Math.floor(out_speed * 10)/10) + ' URI/s)';
      }
    }
    inqdiv.append('IncomingQueue: ' + in_text + ', ' + out_text +
		  ', ' + nq_text);
    last_status_update = now;
    last_inq_in = inq.addedcount;					
    last_inq_out = inq.processedcount;
    d.append(inqdiv);
  }
  var sch = data.sch;
  if (sch) {
    var clients = sch.clients;
    if (clients) {
      d.append(jQuery('<div>').html('Clients:'));
      var tbl = jQuery('<table border="1">');
      var r = tbl.get(0).insertRow(-1);
      jQuery.each(['id','scheduled','fed','finished','next','worksets',
		   'lastfed','nqfiles'],
             function(i, s){ jQuery(r.insertCell(-1)).text(s); });
      jQuery.each(clients, function(k, v){
          r = tbl.get(0).insertRow(-1);
          jQuery(r).addClass('client');
          jQuery(r.insertCell(-1)).text(k).attr({align:'right'});
          jQuery.each(['scheduledcount','feedcount','finishedcount','next','worksetcount','lastfeedcount','qfilecount'],
		function(i, p){
		    if (v[p] == null)
		        v[p] = '-';
		    else if (p.match('count$$'))
			v[p] = with_comma(v[p]);
		    jQuery(r.insertCell(-1)).text(v[p]).attr({align:'right'});
		});
        });
      d.append(tbl);
    }
  }
}
function getjobname(e) {
  return jQuery(e).closest('.job').attr('jobname');
}
function showstatus(ev) {
  ev.preventDefault();
  var job = getjobname(this);
  if (!job) { alert('failed to identify job name'); return; }
  jQuery.ajax('jobs/'+job+'/status', {
    dataType:'json',
    success: renderstatus,
    beforeSend: function(){ jQuery(ev.target).addClass('wait'); },
    complete: function() { jQuery(ev.target).removeClass('wait'); }
  });
}
function with_comma(n) {
  var digits = String(n).match(/./g);
  for (var i = digits.length - 3; i > 0; i -= 3) {
    digits.splice(i, 0, ',');
  }
  return digits.join('');  
}
function update_seencount() {
  var job = getjobname(this);
  var jobel = jQuery(this).closest('.job');
  jQuery('.seencount', jobel).addClass('loading wait');
  jQuery.ajax('jobs/'+encodeURIComponent(job)+'/seencount', {
    dataType:'json',
    success: function(data){
      jQuery('.seencount', jobel).text(with_comma(data.seencount));
    },
    complete: function(){ jQuery('.seencount', jobel).removeClass('loading wait'); }
  });
}
function flush_job() {
  var btn = this;
  var job = getjobname(this);
  jQuery.ajax('jobs/'+encodeURIComponent(job)+'/flush', {
    dataType:'json',
    beforeSend:function(){jQuery(btn).addClass('wait');},
    success:function(data){
      if (!data.ok) {
        alert('job ' + job + ' flush failed');
      }
    },
    complete:function(){jQuery(btn).removeClass('wait');}
  });
}
jQuery('.seencheck').submit(seencheck);
jQuery('.showstatus').click(showstatus);
jQuery('button.update-seencount').click(update_seencount);
jQuery('button.flush').click(flush_job);
</script>
</html>
